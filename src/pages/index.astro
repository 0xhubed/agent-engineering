---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const allArticles = await getCollection('articles');
const articles = allArticles.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

const featured = articles.find(a => a.data.featured) ?? articles[0];
const remaining = articles.filter(a => a.slug !== featured?.slug);

const leftCol = remaining.slice(0, 3);
const rightCol = remaining.slice(3, 6);
const recent = remaining.slice(6, 9);

function fmtDate(d: string) {
  const dt = new Date(d + 'T12:00:00');
  if (isNaN(dt.getTime())) return d;
  return dt.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}

interface NewsItem { title: string; url: string; summary: string; source: string; }
interface NewsData { last_updated: string | null; items: NewsItem[]; }
let news: NewsItem[] = [];
try {
  const raw = await import('../data/news.json');
  news = (raw.default as unknown as NewsData).items
    ?.filter(item => item.url?.startsWith('https://') || item.url?.startsWith('http://'))
    .slice(0, 4) ?? [];
} catch { /* no news file */ }
---

<BaseLayout title="Agent Engineering" showMasthead={true}>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Featured Article -->
    {featured && (
      <section class="mb-6">
        <div class="text-center mb-4">
          <span class="section-label">{featured.data.category}</span>
        </div>
        <a href={`/articles/${featured.slug}/`} class="block no-underline group">
          <h2 class="font-display font-bold text-ink text-center leading-tight mb-3 group-hover:underline"
              style="font-size: clamp(1.6rem, 3.5vw, 2.5rem);">
            {featured.data.title}
          </h2>
          <p class="font-serif italic text-ink-muted text-center max-w-2xl mx-auto leading-relaxed">
            {featured.data.description}
          </p>
        </a>
        <div class="flex justify-center gap-4 mt-3">
          <span class="byline">By the Editors</span>
          <span class="font-serif text-xs text-ink-faint">{fmtDate(featured.data.date)}</span>
        </div>
      </section>
    )}

    <hr class="rule-double mb-6" />

    <!-- Two-column grid -->
    {(leftCol.length > 0 || rightCol.length > 0) && (
      <section class="mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-0 divide-y sm:divide-y-0 sm:divide-x divide-newsprint-300">

          <!-- Left column -->
          <div class="sm:pr-8 space-y-5">
            {leftCol.map((article) => (
              <div class="article-card">
                <span class="section-label block mb-1">{article.data.category}</span>
                <a href={`/articles/${article.slug}/`} class="no-underline group">
                  <h3 class="article-card-title text-xl mb-1 group-hover:underline">
                    {article.data.title}
                  </h3>
                </a>
                <p class="article-card-summary">{article.data.description}</p>
                <span class="font-serif text-xs text-ink-faint mt-1 block">{fmtDate(article.data.date)}</span>
              </div>
            ))}
          </div>

          <!-- Right column -->
          <div class="sm:pl-8 space-y-5 pt-5 sm:pt-0">
            {rightCol.map((article) => (
              <div class="article-card">
                <span class="section-label block mb-1">{article.data.category}</span>
                <a href={`/articles/${article.slug}/`} class="no-underline group">
                  <h3 class="article-card-title text-xl mb-1 group-hover:underline">
                    {article.data.title}
                  </h3>
                </a>
                <p class="article-card-summary">{article.data.description}</p>
                <span class="font-serif text-xs text-ink-faint mt-1 block">{fmtDate(article.data.date)}</span>
              </div>
            ))}
          </div>

        </div>
      </section>
    )}

    <hr class="rule-double mb-6" />

    <!-- Recent Dispatches -->
    {recent.length > 0 && (
      <section class="mb-10">
        <h2 class="font-display text-xs tracking-widest uppercase text-ink-muted text-center mb-5"
            style="letter-spacing: 0.2em;">
          Recent Dispatches
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          {recent.map((article) => (
            <div class="article-card">
              <span class="section-label block mb-1">{article.data.category}</span>
              <a href={`/articles/${article.slug}/`} class="no-underline group">
                <h3 class="article-card-title text-base mb-1 group-hover:underline">
                  {article.data.title}
                </h3>
              </a>
              <p class="article-card-summary text-xs">{article.data.description}</p>
              <span class="font-serif text-xs text-ink-faint mt-1 block">{fmtDate(article.data.date)}</span>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- All articles link -->
    {articles.length > 9 && (
      <div class="text-center mt-4">
        <a href="/articles/" class="font-serif text-sm text-ink-muted">
          View all {articles.length} articles &rarr;
        </a>
      </div>
    )}

    <!-- Latest News -->
    {news.length > 0 && (
      <section class="mt-10 pt-6 border-t border-newsprint-300">
        <h2 class="font-display text-xs tracking-widest uppercase text-ink-muted text-center mb-5"
            style="letter-spacing: 0.2em;">
          Latest from the Field
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {news.map((item) => (
            <div class="article-card">
              <a href={item.url} target="_blank" rel="noopener noreferrer" class="no-underline group">
                <h4 class="font-display font-semibold text-ink text-sm mb-1 group-hover:underline">
                  {item.title}
                </h4>
              </a>
              <p class="font-serif text-xs text-ink-muted leading-snug">{item.summary}</p>
              <span class="font-serif text-xs text-ink-faint mt-1 block">{item.source}</span>
            </div>
          ))}
        </div>
      </section>
    )}

  </div>
</BaseLayout>
